
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ± Bingo Pro â€” Voz Latina</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/static/css/game.css">
</head>
<body>

<header>
  <div>
    <div class="logo">ğŸ± Bingo Pro <span>MADE BY RENSO RAMIREZ</span></div>
  </div>
  <div class="header-right">
    <div class="nav-links">
      <a href="/" class="nav-link active">ğŸ® Juego</a>
      <a href="/cartillas" class="nav-link">ğŸ´ Cartillas</a>
      {% if is_admin %}
      <a href="/admin" class="nav-link">ğŸ›  Admin</a>
      <a href="#" class="nav-link" onclick="logout()">ğŸšª Salir</a>
      {% else %}
      <a href="/admin/login" class="nav-link">ğŸ”’ Admin</a>
      {% endif %}
    </div>
    <div id="connection-info">
      Abre en cualquier dispositivo:<br>
      <strong id="server-url">cargandoâ€¦</strong>
    </div>
    <div id="timer">â± 00:00</div>
  </div>
</header>

<div class="stats-bar">
  <div class="stat">Sorteadas: <strong id="stat-drawn">0</strong></div>
  <div class="stat">Restantes: <strong id="stat-rem">90</strong></div>
  <div class="progress-wrap"><div class="progress-bar" id="progress"></div></div>
  <div class="stat"><strong id="stat-pct">0%</strong></div>
  <div class="shortcuts">[Space] Sortear &nbsp; [R] Repetir &nbsp; [A] Auto &nbsp; [Esc] Silenciar &nbsp; [N] Nuevo</div>
</div>

<div class="main">

  <!-- LEFT -->
  <div class="left-col">

    <div class="number-display">
      <div id="ball-wrapper">
        <div id="ball">
          <div id="big-number">?</div>
        </div>
      </div>
      <div class="number-info">
        <div class="number-label">Bolilla</div>
        <div id="words-display">â€”</div>
        <div id="group-tag"></div>
        <div id="auto-cd"></div>
        <!-- FIX: IDs match game.js (auto-bar-wrap / auto-bar) -->
        <div id="auto-bar-wrap"><div id="auto-bar"></div></div>
      </div>
    </div>

    <div class="recent-strip">
      <span class="recent-label">Ãšltimas:</span>
      <div id="recent-nums" style="display:flex;gap:10px;"></div>
    </div>

    <div class="grid-section">
      <div class="section-title">NÃºmeros Sorteados</div>
      <div class="group-headers" id="group-headers"></div>
      <div class="num-grid" id="num-grid"></div>
    </div>

  </div>

  <!-- RIGHT -->
  <div class="right-col">

    <div class="panel">
      <div class="panel-title">Controles</div>

      <button class="btn btn-draw admin-only" id="btn-draw" onclick="drawNumber()">ğŸ± SORTEAR</button>

      <div class="auto-row">
        <button class="btn btn-auto admin-only" id="btn-auto" onclick="toggleAuto()">â² Auto [A]</button>
        <input class="spinbox admin-only" type="number" id="auto-interval" min="3" max="60" value="10"> s
      </div>

      <div class="btn-row" style="margin-bottom:8px;">
        <button class="btn btn-sm admin-only" onclick="repeatLast()">ğŸ” Repetir [R]</button>
        <button class="btn btn-sm admin-only" onclick="stopAudio()">ğŸ”‡ Silenciar</button>
      </div>

      <button class="btn btn-new admin-only" onclick="newGame()">ğŸ”„ Nuevo Juego [N]</button>

      <div class="slider-label">
        <span>Velocidad animaciÃ³n</span>
        <span id="speed-val">55</span>
      </div>
      <input type="range" min="0" max="100" value="55" id="speed-slider"
             class="admin-only"
             oninput="document.getElementById('speed-val').textContent=this.value">
    </div>

    <div class="panel">
      <div class="panel-title">Voz & Audio</div>
      <select id="voice-select" class="admin-only">
        <option value="es-MX-DaliaNeural">ğŸ‡²ğŸ‡½ Dalia (MÃ©xico)</option>
        <option value="es-MX-JorgeNeural">ğŸ‡²ğŸ‡½ Jorge (MÃ©xico)</option>
        <option value="es-AR-ElenaNeural">ğŸ‡¦ğŸ‡· Elena (Argentina)</option>
        <option value="es-ES-ElviraNeural">ğŸ‡ªğŸ‡¸ Elvira (EspaÃ±a)</option>
        <option value="es-PE-CamilaNeural">ğŸ‡µğŸ‡ª Camila (PerÃº)</option>
      </select>

      <div class="slider-label">
        <span>ğŸ”Š Volumen</span>
        <span id="vol-val">85%</span>
      </div>
      <input type="range" min="0" max="100" value="85"
             id="vol-slider" class="admin-only"
             oninput="document.getElementById('vol-val').textContent=this.value+'%'">
    </div>

    {% if not is_admin %}
    <div class="panel" style="border-color:rgba(0,229,180,.2);">
      <div class="panel-title">ğŸ‘ Modo Espectador</div>
      <p style="color:var(--muted);font-size:.82rem;line-height:1.6;">
        EstÃ¡s viendo el juego en <strong style="color:var(--accent);">tiempo real</strong>.<br>
        Los nÃºmeros se actualizan automÃ¡ticamente cada 3 segundos.<br><br>
        Â¿Eres el administrador?
      </p>
      <a href="/admin/login" class="btn btn-sm" style="text-decoration:none;text-align:center;margin-top:8px;display:block;">
        ğŸ”’ Iniciar sesiÃ³n como Admin
      </a>
    </div>
    {% endif %}

  </div>
</div>

<div id="toast"></div>

<div id="gameover">
  <h1>ğŸ‰ Â¡BINGO!</h1>
  <p id="gameover-info">Se sortearon las 90 bolillas.</p>
  <button class="btn btn-draw admin-only" onclick="newGame(); hideGameOver()">ğŸ”„ Nueva Partida</button>
  <button class="btn btn-sm" style="margin-top:10px;" onclick="hideGameOver()">Cerrar</button>
</div>

<!--
  IS_ADMIN se verifica en VIVO via API en cada carga de pÃ¡gina.
  Esto garantiza que:
  1) Al cerrar sesiÃ³n (logout) y reabrir, el estado sea correcto.
  2) Si el admin cierra el navegador, la cookie de sesiÃ³n desaparece
     y la prÃ³xima vez que cualquier pestaÃ±a cargue, IS_ADMIN = false.
  3) Un jugador que abre la misma URL que el admin nunca hereda permisos.
-->
<script>
  // Valor provisional mientras llega la respuesta de la API
  let IS_ADMIN = false;

  async function _initAdminStatus() {
    try {
      const res  = await fetch('/api/auth/status');
      const data = await res.json();
      const wasAdmin = IS_ADMIN;
      IS_ADMIN = data.is_admin === true;

      if (wasAdmin !== IS_ADMIN) {
        // Estado cambiÃ³ (ej: sesiÃ³n expirÃ³ o acaban de hacer login)
        // Recargamos para que Flask renderice el HTML correcto
        location.reload();
        return;
      }

      // Aplicar restricciones de rol segÃºn el valor real
      if (typeof applyRoleSecurity === 'function') {
        applyRoleSecurity();
      }
    } catch(e) {
      // Sin conexiÃ³n: asumir no-admin por seguridad
      IS_ADMIN = false;
      if (typeof applyRoleSecurity === 'function') {
        applyRoleSecurity();
      }
    }
  }

  async function logout() {
    await fetch('/api/admin/logout', { method: 'POST' });
    location.reload();
  }
</script>

<script src="/static/js/game.js"></script>

<script>
  // Verificar estado real DESPUÃ‰S de que game.js haya cargado
  // (para que applyRoleSecurity estÃ© definida)
  _initAdminStatus();

  // Re-verificar cada 30 segundos por si la sesiÃ³n expirÃ³ en el servidor
  setInterval(_initAdminStatus, 30000);
</script>

</body>
</html>
